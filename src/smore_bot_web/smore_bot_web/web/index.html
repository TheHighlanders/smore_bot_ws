<!DOCTYPE html>
<html>

<head>
    <title>SMORE Bot Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/roslib@1.3.0/build/roslib.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .dashboard {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .data-card {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 5px solid #3498db;
            background-color: #f9f9f9;
        }

        h1 {
            color: #2c3e50;
        }

        h2 {
            margin: 0;
            color: #3498db;
        }

        .value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }

        .status-good {
            color: #2ecc71;
        }

        .status-warning {
            color: #f39c12;
        }

        .status-error {
            color: #e74c3c;
        }

        #connection-status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }

        .connected {
            background-color: #d5f5e3;
            color: #27ae60;
        }

        .disconnected {
            background-color: #f5b7b1;
            color: #c0392b;
        }
    </style>
</head>

<body>
    <div class="dashboard">
        <div id="connection-status" class="disconnected">
            Connecting to ROS...
        </div>

        <h1>SMORE Bot Dashboard</h1>

        <div class="data-card">
            <h2>State</h2>
            <div id="state" class="value">Waiting...</div>
        </div>

        <div class="data-card">
            <h2>System Health</h2>
            <div id="health" class="value">Waiting...</div>
        </div>

        <div class="data-card">
            <h2>Battery Level</h2>
            <div id="battery" class="value">Waiting...</div>
        </div>

        <div class="data-card">
            <h2>Temperature</h2>
            <div id="temperature" class="value">Waiting...</div>
        </div>
    </div>

    <script>
        document.addEventListener('visibilitychange', function () {
            if (document.visibilityState === 'visible') {
                console.log('Page is now visible, ensuring connection');
                // Force reconnection if needed
                if (!ros.isConnected) {
                    ros.connect('ws://' + window.location.hostname + ':9090');
                }
            }
        });

        var ros = new ROSLIB.Ros({
            url: 'ws://' + window.location.hostname + ':9090'
        });

        ros.on('connection', function () {
            console.log('Connected to websocket server.');
            document.getElementById('connection-status').className = 'connected';
            document.getElementById('connection-status').textContent = 'Connected to ROS';
        });

        ros.on('error', function (error) {
            console.log('Error connecting to websocket server: ', error);
            document.getElementById('connection-status').className = 'disconnected';
            document.getElementById('connection-status').textContent = 'Error connecting to ROS';
        });

        ros.on('close', function () {
            console.log('Connection to websocket server closed.');
            document.getElementById('connection-status').className = 'disconnected';
            document.getElementById('connection-status').textContent = 'Connection closed';
        });

        // State topic subscriber
        var stateTopic = new ROSLIB.Topic({
            ros: ros,
            name: '/smore_bot/state',
            messageType: 'std_msgs/String'
        });

        stateTopic.subscribe(function (message) {
            document.getElementById('state').textContent = message.data;
        });

        // Health topic subscriber
        var healthTopic = new ROSLIB.Topic({
            ros: ros,
            name: '/smore_bot/system_health',
            messageType: 'std_msgs/Bool'
        });

        healthTopic.subscribe(function (message) {
            const healthElement = document.getElementById('health');
            if (message.data) {
                healthElement.textContent = "OK";
                healthElement.className = "value status-good";
            } else {
                healthElement.textContent = "ERROR";
                healthElement.className = "value status-error";
            }
        });

        // Battery topic subscriber
        var batteryTopic = new ROSLIB.Topic({
            ros: ros,
            name: '/smore_bot/battery_level',
            messageType: 'std_msgs/Float32'
        });

        batteryTopic.subscribe(function (message) {
            const batteryElement = document.getElementById('battery');
            batteryElement.textContent = message.data.toFixed(1) + "%";
            if (message.data > 80) {
                batteryElement.className = "value status-good";
            } else if (message.data > 40) {
                batteryElement.className = "value status-warning";
            } else {
                batteryElement.className = "value status-error";
            }
        });

        // Temperature topic subscriber
        var temperatureTopic = new ROSLIB.Topic({
            ros: ros,
            name: '/smore_bot/temperature',
            messageType: 'std_msgs/Float32'
        });

        temperatureTopic.subscribe(function (message) {
            document.getElementById('temperature').textContent = message.data.toFixed(1) + "Â°F";
        });

        function keepAlive() {
            if (ros.isConnected) {
                console.log('Keep-alive ping at ' + new Date().toLocaleTimeString());
            }

            requestAnimationFrame(function () {
                setTimeout(keepAlive, 4000);
            });
        }
    </script>
</body>

</html>